<?xml version="1.0"?>
<project name="jscombine" default="concatenate" basedir="..">

  <!-- 
    Javascript minifier and concatenator Ant build script
    Author: Chris Batchelor, @FiregobyDesign
    Credits: Based on code from HTML5Boilerplate, all glory goes
        to Paul Irish and co with thanks, any bugs are probably me ;o)
  -->

  <target name="concatenate" depends="minify" description="Concatenate all js files">
    <echo message="Concatenating javascripts into production.min.js..."/>
    <concat destfile="production.min.js">
      <fileset dir="." includes="**/*.min.js">
        <exclude name="production.min.js"/>
        <exclude name="libs/*.js"/>
      </fileset>
    </concat>
    <echo message="Deleting temporary minified .js files..."/>
    <delete>
      <fileset dir="." includes="**/*.min.js">
        <exclude name="production.min.js"/>
        <exclude name="libs/*.min.js"/>
      </fileset>
    </delete>
  </target>

  <target name="minify" depends="coffeescript">
    <echo message="Deleting old minified .js files..."/>
    <delete>
      <fileset dir="." includes="**/*.min.js">
        <exclude name="libs/*.min.js"/>
      </fileset>
    </delete>
    <echo message="Minifying javascript files..."/>
    <apply executable="java" parallel="false">
      <fileset dir=".">
        <include name="**/*.js"/>
        <exclude name="libs/*.js"/>
      </fileset>
      <arg line="-jar"/>
      <arg path="build/yuicompressor-2.4.6.jar"/>
      <srcfile/>
      <arg line="--line-break 4000"/>
      <arg line="--nomunge"/>
      <arg line="--preserve-semi"/>
      <arg line="--disable-optimizations"/>
      <arg line="-o"/>
      <mapper type="glob" from="*.js" to="../*.min.js"/>
      <targetfile/>
    </apply>
  </target>

  <target name="coffeescript">
    <echo message="Compiling Coffeescript..."/>
    <apply executable="coffee" parallel="false">
      <fileset dir=".">
        <include name="**/*.coffee"/>
      </fileset>
      <arg line="-cl"/>
      <srcfile/>
    </apply>
  </target>

</project>
